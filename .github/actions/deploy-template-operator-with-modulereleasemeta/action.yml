name: Deploy template-operator With ModuleReleaseMeta
description: Deploys a test-specific template-operator and corresponding ModuleReleaseMeta.
inputs:
  module_version:
    description: "Version of the template operator to be deployed, should be aligned with the version in versions.yaml"
    required: true
runs:
  using: composite
  steps:
    - uses: ./lifecycle-manager/.github/actions/switch-kubectl-context
      with:
        context_name: k3d-kcp
    - name: Copy generate moduletemplate script to template-operator directory
      working-directory: template-operator
      shell: bash
      run: |
        cp ../lifecycle-manager/scripts/tests/deploy_moduletemplate.sh .
        cp ../lifecycle-manager/scripts/tests/deploy_modulereleasemeta.sh .
        cp ../lifecycle-manager/scripts/tests/deploy_mandatory_modulereleasemeta.sh .
        cp ../lifecycle-manager/scripts/tests/ocm-config-local-registry.yaml .
        cp ../lifecycle-manager/scripts/tests/ocm-config-private-registry.yaml .
    - name: Create and apply Template Operator ModuleTemplate from the latest release
      working-directory: template-operator
      if: ${{ matrix.e2e-test != 'mandatory-module' &&
        matrix.e2e-test != 'mandatory-module-metrics' &&
        matrix.e2e-test != 'watcher-zero-downtime' &&
        matrix.e2e-test != 'oci-reg-cred-secret'
        }}
      shell: bash
      run: |
        yq eval '.images[0].newTag = "${{ inputs.module_version }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests

        if [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-ignore-policy" ]] || \
           [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-create-and-delete-policy" ]]; then
          # Make Sample CRD cluster-scoped for cluster-scoped CR tests
          crd_selector='select(.kind == "CustomResourceDefinition" and .metadata.name == "samples.operator.kyma-project.io")'
          yq eval "(${crd_selector} | .spec.scope) = \"Cluster\"" -i template-operator.yaml
        fi

        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ inputs.module_version }} ${{ inputs.module_version }} true false true false
    - name: Create and apply Template Operator ModuleTemplate with ModuleDeploymentNameInOlderVersion
      working-directory: template-operator
      if: ${{ matrix.e2e-test != 'mandatory-module' &&
        matrix.e2e-test != 'mandatory-module-metrics' &&
        matrix.e2e-test != 'watcher-zero-downtime' &&
        matrix.e2e-test != 'oci-reg-cred-secret'
        }}
      shell: bash
      run: |
        yq eval '.images[0].newTag = "${{ env.OlderVersion }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests
        yq eval '(. | select(.kind == "Deployment") | .metadata.name) = "${{ env.ModuleDeploymentNameInOlderVersion }}"' -i template-operator.yaml

        if [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-ignore-policy" ]] || \
           [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-create-and-delete-policy" ]]; then
          # Make Sample CRD cluster-scoped for cluster-scoped CR tests
          crd_selector='select(.kind == "CustomResourceDefinition" and .metadata.name == "samples.operator.kyma-project.io")'
          yq eval "(${crd_selector} | .spec.scope) = \"Cluster\"" -i template-operator.yaml
        fi

        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ env.OlderVersion }} ${{ inputs.module_version }} true false true false
    - name: Create and apply Template Operator ModuleTemplate with ModuleDeploymentNameInNewerVersion
      working-directory: template-operator
      if: ${{ matrix.e2e-test != 'mandatory-module' &&
        matrix.e2e-test != 'mandatory-module-metrics' &&
        matrix.e2e-test != 'watcher-zero-downtime' &&
        matrix.e2e-test != 'oci-reg-cred-secret'
        }}
      shell: bash
      run: |
        INCLUDE_DEFAULT_CR=true
        MANDATORY=false
        DEPLOY_MODULETEMPLATE=true
        if [[ "${{ matrix.e2e-test }}" == "maintenance-windows" ]] ||
           [[ "${{ matrix.e2e-test }}" == "maintenance-windows-initial-installation" ]] ||
           [[ "${{ matrix.e2e-test }}" == "maintenance-windows-skip" ]]; then
          REQUIRE_DOWNTIME=true
        else
          REQUIRE_DOWNTIME=false
        fi

        yq eval '.images[0].newTag = "${{ env.NewerVersion }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests
        yq eval '(. | select(.kind == "Deployment") | .metadata.name) = "${{ env.ModuleDeploymentNameInNewerVersion }}"' -i template-operator.yaml

        if [[ "${{ matrix.e2e-test }}" == "module-api-upgrade-under-blocked-deletion" ]]; then
          # Introduce v1beta1 in the CRD to simulate the API upgrade scenario
          crd_selector='select(.kind == "CustomResourceDefinition" and .metadata.name == "samples.operator.kyma-project.io")'
          yq eval "${crd_selector} |= (.spec.versions += [{\"name\": \"v1beta1\", \"served\": true, \"storage\": true, \"schema\": .spec.versions[0].schema}])" -i template-operator.yaml
          yq eval "(${crd_selector} | .spec.versions[] | select(.name == \"v1alpha1\")).storage = false" -i template-operator.yaml
          yq eval '.apiVersion = "operator.kyma-project.io/v1beta1"' -i config/samples/default-sample-cr.yaml
        fi

        if [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-ignore-policy" ]] || \
           [[ "${{ matrix.e2e-test }}" == "module-deletion-blocking-with-cluster-scoped-crs-create-and-delete-policy" ]]; then
          # Make Sample CRD cluster-scoped for cluster-scoped CR tests
          crd_selector='select(.kind == "CustomResourceDefinition" and .metadata.name == "samples.operator.kyma-project.io")'
          yq eval "(${crd_selector} | .spec.scope) = \"Cluster\"" -i template-operator.yaml
        fi

        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ env.NewerVersion }} ${{ inputs.module_version }} $INCLUDE_DEFAULT_CR $MANDATORY $DEPLOY_MODULETEMPLATE $REQUIRE_DOWNTIME


    - name: Create and apply Template Operator ModuleTemplate in private registry
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'oci-reg-cred-secret' }}
      shell: bash
      run: |
        MODULE_CONFIG="./module-config.yaml"
        REGISTRY_URL="k3d-private-oci-reg.localhost:5001"
        REGISTRY_CREDS="myuser:mypass"
        COMPONENT_CONSTRUCTOR_FILE="./component-constructor.yaml"
        CTF_DIR="./component-ctf"
        TEMPLATE_FILE="./template.yaml"
        TARGET_REGISTRY="private-oci-reg.localhost:5000"
        OCM_CONFIG="./ocm-config-private-registry.yaml"

        echo "creating ModuleTemplate"
        modulectl create \
          --config-file "${MODULE_CONFIG}" \
          --disable-ocm-registry-push \
          --output-constructor-file "${COMPONENT_CONSTRUCTOR_FILE}"

        echo "pushing OCM components..."
        ocm --config "${OCM_CONFIG}" add componentversions --create --file "${CTF_DIR}" --skip-digest-generation "${COMPONENT_CONSTRUCTOR_FILE}"
        ocm --config "${OCM_CONFIG}" transfer ctf \
          --overwrite \
          --no-update \
          "${CTF_DIR}" \
          "http://${REGISTRY_URL}"

        echo "Verifying component in private registry..."
        curl -s -u myuser:mypass "http://${REGISTRY_URL}/v2/_catalog" || echo "Warning: Could not verify registry catalog"

        echo "No baseUrl patching needed for private registry..."
        kubectl get crds
        kubectl apply -f <(yq eval '.metadata.namespace = "kcp-system"' "${TEMPLATE_FILE}")
    - name: Create and apply ModuleReleaseMeta from the template-operator repo
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'kyma-metrics' ||
        matrix.e2e-test == 'purge-controller' ||
        matrix.e2e-test == 'purge-metrics' ||
        matrix.e2e-test == 'kyma-deprovision-with-foreground-propagation' ||
        matrix.e2e-test == 'kyma-deprovision-with-background-propagation' ||
        matrix.e2e-test == 'module-consistency' ||
        matrix.e2e-test == 'skip-manifest-reconciliation' ||
        matrix.e2e-test == 'misconfigured-kyma-secret' ||
        matrix.e2e-test == 'unmanage-module' ||
        matrix.e2e-test == 'modulereleasemeta-watch-trigger' ||
        matrix.e2e-test == 'modulereleasemeta-with-obsolete-moduletemplate' ||
        matrix.e2e-test == 'labelling' ||
        matrix.e2e-test == 'module-deletion-with-only-default-cr' ||
        matrix.e2e-test == 'module-deletion-blocking-with-multiple-crs-ignore-policy' ||
        matrix.e2e-test == 'module-deletion-blocking-with-multiple-crs-create-and-delete-policy' ||
        matrix.e2e-test == 'module-deletion-blocking-with-default-cr-with-finalizer' ||
        matrix.e2e-test == 'module-deletion-blocking-with-cross-namespace-ignore-policy' ||
        matrix.e2e-test == 'module-deletion-blocking-with-cross-namespace-create-and-delete-policy' ||
        matrix.e2e-test == 'module-deletion-blocking-with-cluster-scoped-crs-ignore-policy' ||
        matrix.e2e-test == 'module-deletion-blocking-with-cluster-scoped-crs-create-and-delete-policy' ||
        matrix.e2e-test == 'oci-reg-cred-secret' ||
        matrix.e2e-test == 'module-transferred-to-another-oci-registry'
        }}
      shell: bash
      run: |
        kubectl apply -f module-release-meta.yaml
    - name: Create and apply ModuleReleaseMeta for regular and fast channels
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'module-upgrade-channel-switch' ||
        matrix.e2e-test == 'modulereleasemeta-module-upgrade-new-version' ||
        matrix.e2e-test == 'modulereleasemeta-upgrade-under-deletion' ||
        matrix.e2e-test == 'module-api-upgrade-under-blocked-deletion' ||
        matrix.e2e-test == 'modulereleasemeta-sync' ||
        matrix.e2e-test == 'module-status-on-skr-connection-lost' ||
        matrix.e2e-test == 'modulereleasemeta-not-allowed-installation' ||
        matrix.e2e-test == 'maintenance-windows' ||
        matrix.e2e-test == 'maintenance-windows-initial-installation' ||
        matrix.e2e-test == 'maintenance-windows-skip' ||
        matrix.e2e-test == 'simulate-skr-secret-rotation-evict-client-cache'||
        matrix.e2e-test == 'skr-image-pull-secret-sync'
        }}
      shell: bash
      run: |
        ./deploy_modulereleasemeta.sh ${{ env.ModuleName }} fast:${{ env.NewerVersion }} regular:${{ env.OlderVersion }}
    - name: Create and apply ModuleReleaseMeta Template Operator with newer version in fast channel and older version in regular channel
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'non-blocking-deletion' }}
      shell: bash
      run: |
        ./deploy_modulereleasemeta.sh ${{ env.ModuleName }} fast:${{ env.NewerVersion }} regular:${{ inputs.module_version }}
    - name: Create ModuleTemplate and ModuleReleaseMeta for Module Status test with Deployment
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'module-status-decoupling-with-deployment'}}
      shell: bash
      run: |
        # Create and apply ModuleReleaseMeta with version when deployment is in warning state
        yq eval '.images[0].newTag = "${{ env.VersionForDeploymentInWarning }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests
        yq eval '(. | select(.kind == "Deployment") | .spec.template.spec.containers[0].args) = ["--leader-elect", "--final-state=Warning", "--final-deletion-state=Warning"]' -i template-operator.yaml
        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ env.VersionForDeploymentInWarning }} ${{ inputs.module_version }} true false true false
        ./deploy_modulereleasemeta.sh ${{ env.ModuleName }} regular:${{ env.VersionForDeploymentInWarning }}

        # Create and apply ModuleReleaseMeta with version when deployment is misconfigured
        yq eval '.images[0].newTag = "${{ env.VersionForMisconfiguredDeploymentImage }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests
        yq eval '(. | select(.kind == "Deployment") | .spec.template.spec.containers[0].image) = "non-working/path:0.0.1"' -i template-operator.yaml
        yq eval '(. | select(.kind == "Deployment") | .spec.progressDeadlineSeconds) = 60' -i template-operator.yaml
        yq eval '(. | select(.kind == "Deployment") | .spec.template.spec.containers[0].livenessProbe) = {
          "httpGet": {"path": "/healthz", "port": 8081},
          "initialDelaySeconds": 5, "periodSeconds": 5, "failureThreshold": 1
        }' -i template-operator.yaml
        yq eval '(. | select(.kind == "Deployment") | .spec.template.spec.containers[0].readinessProbe) = {
          "httpGet": {"path": "/readyz", "port": 8081},
          "initialDelaySeconds": 5, "periodSeconds": 5, "failureThreshold": 1
        }' -i template-operator.yaml
        ./deploy_moduletemplate.sh ${{ env.MisconfiguredModuleName }} ${{ env.VersionForMisconfiguredDeploymentImage }} ${{ inputs.module_version }} true false true false
        ./deploy_modulereleasemeta.sh ${{ env.MisconfiguredModuleName }} regular:${{ env.VersionForMisconfiguredDeploymentImage }}
    - name: Create ModuleTemplate and ModuleReleaseMeta for Module Status test with StatefulSet
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'module-status-decoupling-with-statefulset'}}
      shell: bash
      run: |
        # Create and apply ModuleReleaseMeta with version when statefulset is in warning state
        yq eval '.images[0].newTag = "${{ env.VersionForStatefulSetInWarning }}"' -i config/manager/statefulset/kustomization.yaml
        make build-statefulset-manifests
        yq eval '(. | select(.kind == "StatefulSet") | .spec.template.spec.containers[0].args) = ["--leader-elect", "--final-state=Warning", "--final-deletion-state=Warning"]' -i template-operator.yaml
        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ env.VersionForStatefulSetInWarning }} ${{ inputs.module_version }} true false true false
        ./deploy_modulereleasemeta.sh ${{ env.ModuleName }} regular:${{ env.VersionForStatefulSetInWarning }}

        # Create and apply ModuleReleaseMeta with version when statefulset is misconfigured
        yq eval '.images[0].newTag = "${{ env.VersionForMisconfiguredStatefulSetImage }}"' -i config/manager/statefulset/kustomization.yaml
        make build-statefulset-manifests
        yq eval '(. | select(.kind == "StatefulSet") | .spec.template.spec.containers[0].image) = "non-working/path:0.0.2"' -i template-operator.yaml
        ./deploy_moduletemplate.sh ${{ env.MisconfiguredModuleName }} ${{ env.VersionForMisconfiguredStatefulSetImage }} ${{ inputs.module_version }} true false true false
        ./deploy_modulereleasemeta.sh ${{ env.MisconfiguredModuleName }} regular:${{ env.VersionForMisconfiguredStatefulSetImage }}
    - name: Create Template Operator Module without default CR and apply ModuleReleaseMeta
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'module-without-default-cr' }}
      shell: bash
      run: |
        yq eval '.images[0].newTag = "${{ env.VersionForNoDefaultCR }}"' -i config/manager/deployment/kustomization.yaml
        make build-manifests
        ./deploy_moduletemplate.sh ${{ env.ModuleName }} ${{ env.VersionForNoDefaultCR }} ${{ inputs.module_version }} false false true false
        ./deploy_modulereleasemeta.sh ${{ env.ModuleName }} regular:${{ env.VersionForNoDefaultCR }}
    - name: Apply ModuleReleaseMeta with ModuleTemplate with name <modulename>-<channel>
      working-directory: template-operator
      if: ${{ matrix.e2e-test == 'modulereleasemeta-with-obsolete-moduletemplate' }}
      shell: bash
      run: |
        # Export the existing ModuleTemplate
        kubectl get moduletemplate ${{ env.ModuleName }}-${{ inputs.module_version }} -n kcp-system -oyaml > template.yaml

        # Delete the ModuleTemplate in cluster with name <modulename>-<version>
        kubectl delete moduletemplate ${{ env.ModuleName }}-${{ inputs.module_version }} -n kcp-system

        # Create ModuleTemplate with name <modulename>-<channel>
        sed -i 's/${{ env.ModuleName }}-${{ inputs.module_version }}/template-operator-regular/g' ./template.yaml
        kubectl apply -f template.yaml
    - name: Apply ModuleTemplate for the template-operator Module transferred to another public OCI registry (uses manually created ModuleTemplate)
      working-directory: lifecycle-manager
      if: ${{ matrix.e2e-test == 'module-transferred-to-another-oci-registry' }}
      shell: bash
      run: |
        kubectl apply -f tests/e2e/moduletemplate/moduletemplate_template_operator_transferred.yaml
    - name: Debug - Check ModuleTemplate and Component Status
      working-directory: lifecycle-manager
      shell: bash
      run: |
        echo "=== Checking ModuleTemplates in kcp-system ==="
        kubectl get moduletemplates -n kcp-system -o wide || echo "Failed to get ModuleTemplates"

        echo ""
        echo "=== Checking ModuleReleaseMeta ==="
        kubectl get modulereleasemeta -n kcp-system -o wide || echo "Failed to get ModuleReleaseMeta"

        echo ""
        echo "=== Checking if components are in registry ==="
        curl -s "http://localhost:5111/v2/_catalog" || echo "Warning: Could not query registry catalog"

        echo ""
        echo "=== Checking if component version exists ==="
        curl -s "http://localhost:5111/v2/component-descriptors/kyma-project.io/module/template-operator/tags/list" || echo "Warning: Could not list component tags"
