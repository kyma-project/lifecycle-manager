name: E2E Tests

on:
  push:
    branches: [ "main" ]
jobs:
  e2e-integration:
    name: "Run E2E tests"
    runs-on: ubuntu-latest
    env:
      K3D_VERSION: v5.4.7
      ISTIO_VERSION: 1.18.0
      CM_VERSION: v1.12.0
    steps:
      - name: Update /etc/hosts
        run: |
          FILE=/etc/hosts
          if [ -f "$FILE" ]; then
              sudo echo "127.0.0.1 k3d-kyma-registry" | sudo tee -a $FILE
          else
              echo "$FILE does not exist."
              exit 1
          fi
          echo "/etc/hosts file patched"
      - name: Install homebrew and Prerequisites
        run: |
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /root/.profile
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            sudo apt-get update -y
            sudo apt-get install build-essential -y
            mv brew /usr/local/bin
            brew install gcc
            kubectl version --client
      - name: Install Prerequisites
        run: brew install kubectl k3d istioctl cmctl go kyma-cli
      - name: Provision SKR cluster
        run: |
          k3d cluster create skr --k3s-arg '--disable=traefik@server:0'
      - name: Provision KCP cluster
        run: |
          k3d cluster create kcp --agents 4 \
          -p 9443:443@loadbalancer -p 9080:80@loadbalancer \
          --registry-create k3d-kyma-registry.localhost:5111 \
          --k3s-arg '--disable=traefik@server:0'
      - name: Update Kubeconfigs
        run: k3d kubeconfig merge -a -d
      - name: Export required Kubeconfig Env vars
        run: |
          echo "KCP_KUBECONFIG=$(k3d kubeconfig write kcp)" >> $GITHUB_ENV
          echo "SKR_KUBECONFIG=$(k3d kubeconfig write skr)" >> $GITHUB_ENV
      - name: checkout repo
        uses: actions/checkout@v2.3.4
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          cache: true
          go-version-file: 'go.mod'
          cache-dependency-path: 'go.sum'
      - name: Switch kubeconfig context to KCP cluster
        run: kubectl config use-context k3d-kcp
      - name: Install Istio
        run: |
          curl -L https://istio.io/downloadIstio | TARGET_ARCH=x86_64 sh -
          chmod +x istio-$ISTIO_VERSION/bin/istioctl
          mv istio-$ISTIO_VERSION/bin/istioctl /usr/local/bin
          istioctl install -y
      - name: Install Cert Manager
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/$CM_VERSION/cert-manager.yaml
          cmctl check api --wait=2m
      - name: build and push LM to local registry
        run: |
          make docker-build IMG=k3d-kyma-registry.localhost:5111/lifecycle-manager:0.0.1 && \
          make docker-push IMG=k3d-kyma-registry.localhost:5111/lifecycle-manager:0.0.1
      - name: Deploy LM local testing kustomize
        run: |
          if make local-deploy-with-watcher IMG=k3d-kyma-registry.localhost:5111/lifecycle-manager:0.0.1; then
            echo "KLM deployed successfully"
          else
            echo "Deploy encountered some error, will retry after 30 seconds"
            sleep 30
            make local-deploy-with-watcher IMG=k3d-kyma-registry.localhost:5111/lifecycle-manager:0.0.1
          fi
      - name: Export DinD ENV var
        run: echo "DIND=false" >> $GITHUB_ENV
      - name: Run Watcher E2E Tests
        run: |
          make -C tests/e2e_test test-all