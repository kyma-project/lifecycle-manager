apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-webhook-tls
  namespace: {{.Release.Namespace}}
type: Opaque
data:
  ca.crt: {{ .Values.caCert | b64enc }}
  tls.crt: {{ .Values.tls.cert | b64enc }}
  tls.key: {{ .Values.tls.privateKey | b64enc }}

---

apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{.Release.Name}}-webhook
  namespace: {{.Release.Namespace}}
webhooks:
  {{- range $moduleName, $module := fromYaml .Values.modules }}
  - name: {{$moduleName}}.operator.kyma-project.io
  {{- if $module.labels }}
    objectSelector:
      matchLabels:
        {{- $module.labels | toYaml | nindent 8 -}}
  {{- end }}
    admissionReviewVersions:
      - v1
    clientConfig:
      caBundle: {{ $.Values.caCert | b64enc }}
      service:
        name: {{$.Release.Name}}-webhook
        namespace: {{$.Release.Namespace}}
        path: /validate/{{$moduleName}}
    rules:
      - apiGroups:
          - "operator.kyma-project.io"
        apiVersions:
          - "*"
        operations:
          - CREATE
          - UPDATE
          - DELETE
        resources:
        {{- if not $module.statusOnly }}
          - "*"
        {{- else }}
          - "*/status"
        {{- end }}
    sideEffects: NoneOnDryRun
    timeoutSeconds: 15
    failurePolicy: Ignore
  {{- end }}